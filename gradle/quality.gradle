apply plugin: "pmd"
apply plugin: "jacoco"
apply plugin: "findbugs"
apply plugin: "checkstyle"
apply plugin: "com.github.kt3k.coveralls"

// Creates tasks based on the application build variant (productFlavor + buildType = variant)
(android.hasProperty("applicationVariants")
    ? android."applicationVariants"
    : android."libraryVariants").all { variant ->
    def variantName = variant.name.capitalize()
    def autoGenerated = ['**/R.class',
                         '**/R$*.class',
                         '**/BuildConfig.*',
                         '**/*ViewBinding*.*',
                         '**/*Initializer*.*',
                         '**/*Test*.*',
                         '**/*$Lambda$*.*',
                         '**/*Module.*',
                         '**/*Dagger*.*',
                         '**/*MembersInjector*.*',
                         '**/*_Provide*Factory*.*']

    // Generates Lint reports based off the source code.
    variant.assemble.dependsOn "lint$variantName"

    /**
     * Generates Lint reports based off the source code.
     */
    task("pmd$variantName", type: Pmd, dependsOn: "assemble$variantName") {
        group "Reporting"
        description "Generate ${variantName} Pmd reports."

        ignoreFailures = true
        reports {
            xml.enabled = true
            html.enabled = true
        }

        source = files(android.sourceSets.main.java.srcDirs)
        classpath = files(configurations.compile.files)
    }

    /**
     * Generates Jacoco coverage reports based off the unit tests.
     */
    task("jacoco${variantName}Report", type: JacocoReport,
        dependsOn: "test${variantName}UnitTest") {
        group "Reporting"
        description "Generate ${variantName} Jacoco coverage reports."

        reports {
            xml.enabled = true
            html.enabled = true
        }

        // variant.javaCompile.source does not work
        // traverses from starting point
        sourceDirectories = files(android.sourceSets.main.java.srcDirs)
        classDirectories = fileTree(dir: "$buildDir/intermediates/classes", excludes: autoGenerated)
        executionData = fileTree(dir: "$buildDir", includes: [
            "jacoco/test${variantName}UnitTest.exec", // unit test - test${variantName}UnitTest
            "outputs/code-coverage/connected/*coverage.ec" // android test - create${variantName}CoverageReport
        ])
    }

    /**
     * Generates FindBugs reports based off the source code.
     */
    task("findbugs$variantName", type: FindBugs, dependsOn: "assemble$variantName") {
        group "Reporting"
        description "Generate ${variantName} Findbugs reports."

        ignoreFailures = true
        reports {
            xml.enabled = false
            html.enabled = true
        }

        effort = "max"
        reportLevel = "low"
        source = files(android.sourceSets.main.java.srcDirs)
        classpath = files(configurations.compile.files)
        classes = fileTree(dir: "$buildDir/intermediates/classes", excludes: autoGenerated)
    }

    /**
     * Generates Checkstyle reports based off the source code.
     */
    task("checkstyle$variantName", type: Checkstyle, dependsOn: "assemble$variantName") {
        group "Reporting"
        description "Generate ${variantName} Checkstyle reports."

        ignoreFailures = true
        reports.html.enabled = true

        configFile = rootProject.file("./.buildscript/checkstyle-hard.xml")
        source = files(android.sourceSets.main.java.srcDirs)
        classpath = files(configurations.compile.files)
    }
}

// Only allows specifying of a single file
coveralls {
    jacocoReportPath = "${buildDir}/reports/jacoco/jacocoDebugReport/jacocoDebugReport.xml"
}
